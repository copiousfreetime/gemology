#!/usr/bin/env ruby

require 'httparty'
require 'gemology'
require 'gemology/fetch_store_job'
require 'resque'

url  = "http://rubygems.org/specs.4.8.gz"
puts "Downloading #{url}"
resp  = HTTParty.get( url )

specs = Marshal.load( Gem.gunzip( resp.body ))

puts "Submitting #{specs.size} jobs"
i = 0
specs.each do |a|
  spec = ::Gemology::SpecLite.new( *a )
  url = "http://rubygems.org/gems/#{spec.file_name}"
  Resque.enqueue( ::Gemology::FetchStoreJob,  url )
  i += 1
  $stderr.write " #{i}/#{specs.length}\r"
end

puts "All submitted"
